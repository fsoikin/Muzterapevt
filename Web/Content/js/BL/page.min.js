define(["require","exports","../common","ko","ko.mapping","rx","jQuery","text!./Templates/page.html","css!styles/Page.css"],function(n,t,i,r,u,f,e,o){var c=i,s=r,l=u,b=f,h=e,a={Load:"page/load",Update:"page/update"},y=function(){function n(n){this.ControlsDescendantBindings=!0,this.PageId=n.id}return n.prototype.OnLoaded=function(n){var t=this;this.PageElement=h(n),this.PageElement.text().trim()||this.PageElement.text("Right-click here"),this.MenuElement=v.Menu.clone().appendTo("body").hide(),s.applyBindings(this,this.MenuElement[0]);this.PageElement.on("contextmenu",function(n){if(n.which==3){t.MenuElement.css({top:n.pageY,left:n.pageY}).fadeIn(100);h(document).one("click",function(){return t.MenuElement.fadeOut(100)});return!1}})},n.prototype.OnEdit=function(){var n=this.Editor||(this.Editor=new p(this));n.Show()},n}(),p=function(){function n(n){var t=this;this.Page=n,this.IsLoading=s.observable(!1),this.Error=s.observable(),this.Text=s.observable(""),this.Title=s.observable(""),c.Api.Get(a.Load,{id:n.PageId},this.IsLoading,this.Error,function(n){return l.fromJS(n,{},t)})}return n.prototype.Save=function(){var n=this,t=l.toJS(this);t.Id=this.Page.PageId,c.Api.Post(a.Update,t,this.IsLoading,this.Error,function(t){n.Close(),n.Page.PageElement.html(t).prepend(h("<h2>").text(n.Title()))})},n.prototype.Cancel=function(){this.Close()},n.prototype.Close=function(){this.Element&&this.Element.fadeOut()},n.prototype.Show=function(){(this.Element||(this.Element=this.CreateElement())).fadeIn()},n.prototype.CreateElement=function(){var n=v.Editor.clone().appendTo("body");return s.applyBindings(this,n[0]),n},n}(),w=o,v=function(){var n=h(w);return{Menu:n.filter(".page-menu"),Editor:n.filter(".page-editor")}}();return y})